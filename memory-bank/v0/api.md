# TwinCore Digital Twin API Specification - v1

This document outlines the API endpoints provided by the Digital Twin Layer (Dev B) for interaction with the Canvas/Orchestration Layer (Dev A).

**Base URL:** `/v1` (Assumed prefix for all endpoints)

**Authentication:** All endpoints will require Bearer token authentication (details TBD).

**Data Models:** All request and response bodies should be formalized using Pydantic models defined in `twincore_backend/api/models.py`.

---

## 1. Admin Endpoints

### 1.1 Seed Data

*   **Endpoint:** `POST /admin/api/seed_data`
*   **Description:** Seeds the system with initial mock data for testing and demonstration purposes.
*   **Request Body:** None
*   **Responses:**
    *   `202 Accepted`: Seeding operation started.
      ```json
      {
        "status": "success",
        "message": "Successfully seeded X items",
        "data": {
          "total": 15,
          "counts_by_type": {
            "message": 8,
            "document_chunk": 7
          }
        }
      }
      ```
    *   `500 Internal Server Error`: If seeding operation fails. Details in response body.
    *   `401 Unauthorized`: Missing or invalid authentication token.

### 1.2 Clear Data

*   **Endpoint:** `POST /admin/api/clear_data`
*   **Description:** Clears all data from the system. This is a destructive operation useful for testing, development, or resetting the system to a clean state.
*   **Request Body:** None
*   **Responses:**
    *   `202 Accepted`: Clearing operation started.
      ```json
      {
        "status": "success",
        "message": "All data successfully cleared",
        "data": {
          "details": {
            "neo4j": {
              "nodes_deleted": 25,
              "relationships_deleted": 40
            },
            "qdrant": {
              "vectors_deleted": 30,
              "collection": "twin_memory"
            }
          }
        }
      }
      ```
    *   `500 Internal Server Error`: If clearing operation fails. Details in response body.
    *   `401 Unauthorized`: Missing or invalid authentication token.

---

## 2. Ingestion Endpoints

### 2.1 Ingest Message

*   **Endpoint:** `POST /ingest/message`
*   **Description:** Ingests a single message into the user's memory within a specific session context. The service handles embedding and storage.
*   **Request Body:**
    ```json
    {
      "user_id": "string (uuid)", // REQUIRED: ID of the user who sent the message
      "session_id": "string (uuid)", // REQUIRED: ID of the session the message belongs to
      "project_id": "string (uuid), optional", // Optional: Project ID, can often be derived from session_id
      "message_id": "string (uuid), optional", // Optional: ID of the message from the source system (e.g., Canvas chat)
      "message_text": "string", // REQUIRED: The actual text content of the message
      "timestamp": "string (isoformat)", // REQUIRED: Time the message was created/sent
      "metadata": "object, optional" // Optional: Any additional source-specific metadata
    }
    ```
*   **Responses:**
    *   `202 Accepted`: Message accepted for processing. (Processing happens asynchronously).
      ```json
      {
        "status": "accepted",
        "message": "Message received and queued for ingestion."
      }
      ```
    *   `400 Bad Request`: Invalid request body (e.g., missing required fields, invalid format). Details in response body.
    *   `401 Unauthorized`: Missing or invalid authentication token.
    *   `422 Unprocessable Entity`: Validation error (FastAPI default).

### 2.2 Ingest Document (Text Content)

*   **Endpoint:** `POST /ingest/document`
*   **Description:** Ingests **pre-extracted text content** of a document. The service handles chunking, embedding, and storage, associating it with the user and appropriate context (project/session). Use this when the calling service already has the document's text.
*   **Request Body (application/json):**
    ```json
    {
      "user_id": "string (uuid)", // REQUIRED: ID of the user associated with the document (e.g., owner/uploader)
      "doc_id": "string (uuid)", // REQUIRED: Unique ID for this document (can be generated by caller or service)
      "project_id": "string (uuid), optional", // Context: Project ID, required if session_id is null
      "session_id": "string (uuid), optional", // Context: Session ID, required if project_id is null
      "text": "string", // REQUIRED: Full text content of the document
      "source_uri": "string, optional", // Optional: URI or identifier for the original document location
      "timestamp": "string (isoformat)", // REQUIRED: Time the document was created/uploaded/modified
      "metadata": "object, optional" // Optional: Additional metadata (e.g., original filename, permissions)
    }
    ```
    *Note: At least one of `project_id` or `session_id` must be provided.*
*   **Responses:**
    *   `202 Accepted`: Document text accepted for processing.
      ```json
      {
        "status": "accepted",
        "message": "Document text received and queued for ingestion."
        // Optionally return the doc_id if generated by the service
      }
      ```
    *   `400 Bad Request`: Invalid request body.
    *   `401 Unauthorized`: Missing or invalid authentication token.
    *   `422 Unprocessable Entity`: Validation error.

### 2.3 Ingest Document (File Upload)

*   **Endpoint:** `POST /ingest/document/upload`
*   **Description:** Ingests a document by **direct file upload**. The service handles file reading, text extraction (if necessary, e.g., for PDF), chunking, embedding, and storage.
*   **Request Body (multipart/form-data):**
    *   `file`: The document file itself (e.g., `.txt`, `.md`, `.pdf`). REQUIRED.
    *   `user_id`: `string (uuid)`. REQUIRED: ID of the user uploading the document.
    *   `doc_id`: `string (uuid), optional`. Optional: Provide if you have a specific ID; otherwise, the service can generate one.
    *   `project_id`: `string (uuid), optional`. Context: Project ID.
    *   `session_id`: `string (uuid), optional`. Context: Session ID.
    *   `timestamp`: `string (isoformat), optional`. Optional: Time associated with the document; defaults to now if omitted.
    *   `metadata`: `string (JSON encoded), optional`. Optional: JSON string containing additional metadata.
    *Note: At least one of `project_id` or `session_id` must be provided for context.*
*   **Responses:**
    *   `202 Accepted`: File accepted for processing.
      ```json
      {
        "status": "accepted",
        "message": "File received and queued for ingestion.",
        "doc_id": "string (uuid)" // The ID used for the document (either provided or generated)
      }
      ```
    *   `400 Bad Request`: Missing required form fields (`file`, `user_id`, context ID), invalid metadata JSON.
    *   `401 Unauthorized`: Missing or invalid authentication token.
    *   `413 Payload Too Large`: File exceeds maximum allowed size.
    *   `415 Unsupported Media Type`: File type is not supported for text extraction (e.g., image without OCR).
    *   `422 Unprocessable Entity`: Validation error.

---

## 3. Retrieval Endpoints

### 3.1 Retrieve Context

*   **Endpoint:** `GET /retrieve/context`
*   **Description:** Retrieves relevant text chunks based on a semantic query within a specified user and scope (project/session).
*   **Query Parameters:**
    *   `user_id`: `string (uuid)` - REQUIRED: The user for whom to retrieve context.
    *   `session_id`: `string (uuid), optional` - Scope: Filter by session.
    *   `project_id`: `string (uuid), optional` - Scope: Filter by project.
    *   `query`: `string` - REQUIRED: The natural language query for semantic search.
    *   `limit`: `integer, optional (default: 10)` - Maximum number of chunks to return.
*   **Responses:**
    *   `200 OK`: Successfully retrieved context chunks.
      ```json
      {
        "results": [
          {
            "chunk_id": "string (uuid)",
            "text": "string", // The retrieved text chunk
            "score": "float", // Relevance score from Qdrant
            "metadata": {
              "source_type": "string (e.g., 'message', 'document')",
              "user_id": "string (uuid)",
              "session_id": "string (uuid), optional",
              "project_id": "string (uuid), optional",
              "doc_id": "string (uuid), optional",
              "message_id": "string (uuid), optional",
              "timestamp": "string (isoformat)"
              // ... other relevant metadata from Qdrant payload
            }
          }
          // ... more results up to limit
        ]
      }
      ```
    *   `400 Bad Request`: Missing required query parameters (`user_id`, `query`).
    *   `401 Unauthorized`: Missing or invalid authentication token.
    *   `404 Not Found`: If specified `user_id`, `session_id`, or `project_id` do not exist (optional check).

### 3.2 Retrieve Preferences

*   **Endpoint:** `GET /retrieve/preferences`
*   **Description:** Retrieves known preferences for a user, potentially filtered by project or topic. Combines explicit statements, inferred preferences, and relevant chat history.
*   **Query Parameters:**
    *   `user_id`: `string (uuid)` - REQUIRED: The user whose preferences are being queried.
    *   `project_id`: `string (uuid), optional` - Scope: Filter preferences relevant to a specific project.
    *   `topic`: `string, optional` - Filter preferences related to a specific topic (requires topic extraction/tagging).
*   **Responses:**
    *   `200 OK`: Successfully retrieved preference information.
      ```json
      {
        // Structure TBD based on how preferences are modeled in Neo4j/Qdrant
        "explicit_preferences": [
          { "preference_id": "string", "statement": "string", "topic": "string, optional", "source": "string" }
        ],
        "inferred_from_votes": [
          { "vote_id": "string", "decision": "string", "topic": "string", "user_stance": "string (e.g., 'for', 'against')" }
        ],
        "relevant_statements": [ // Context chunks potentially indicating preference
          {
            "chunk_id": "string (uuid)",
            "text": "string",
            "score": "float", // Relevance score if applicable
            "metadata": { ... } // Similar to context retrieval metadata
          }
        ]
      }
      ```
    *   `400 Bad Request`: Missing required query parameter (`user_id`).
    *   `401 Unauthorized`: Missing or invalid authentication token.

### 3.3 Retrieve Group Context

*   **Endpoint:** `GET /retrieve/group`
*   **Description:** Retrieves relevant information (experiences, preferences, or memories) from multiple participants within a defined group scope (session, project, or team) based on a query.
*   **Query Parameters:**
    *   `session_id`: `string (uuid), optional` - Scope: Required if `project_id` and `team_id` are not provided.
    *   `project_id`: `string (uuid), optional` - Scope: Required if `session_id` and `team_id` are not provided.
    *   `team_id`: `string (uuid), optional` - Scope: Required if `session_id` and `project_id` are not provided.
    *   `query`: `string` - REQUIRED: The natural language query for semantic search across the group.
    *   `limit_per_user`: `integer, optional (default: 5)` - Maximum results per user.
    *Note: Exactly one of `session_id`, `project_id`, or `team_id` must be provided.*
    *   `metadata`: `dict, optional` - Filter here for explicit votes, preferences, or just the results of semantic search across the group.
*   **Responses:**
    *   `200 OK`: Successfully retrieved group context, grouped by user.
      ```json
      {
        "group_results": [
          {
            "user_id": "string (uuid)",
            "results": [ // Array of context chunks for this user
              {
                "chunk_id": "string (uuid)",
                "text": "string",
                "score": "float",
                "metadata": { ... } // Similar to context retrieval metadata
              }
              // ... up to limit_per_user
            ]
          }
          // ... entry for each relevant user in the group
        ]
      }
      ```
    *   `400 Bad Request`: Missing required query parameter (`query`), missing scope ID, or more than one scope ID provided.
    *   `401 Unauthorized`: Missing or invalid authentication token.
    *   `404 Not Found`: If the specified scope ID (`session_id`, `project_id`, `team_id`) does not exist or has no participants.